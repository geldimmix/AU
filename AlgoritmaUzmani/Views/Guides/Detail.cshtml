@model AlgoritmaUzmani.Models.ViewModels.Public.GuideDetailViewModel
@{
    Layout = "_Layout";
    var isEnglish = Model.Language == "en";
    var categoryName = isEnglish && !string.IsNullOrEmpty(Model.Category.NameEn) ? Model.Category.NameEn : Model.Category.NameTr;
    var categorySlug = isEnglish && !string.IsNullOrEmpty(Model.Category.SlugEn) ? Model.Category.SlugEn : Model.Category.SlugTr;
}

@section Styles {
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" rel="stylesheet" />
    <style>
        .guide-header {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }
        .guide-header-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: var(--text-light);
        }
        .guide-header-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Code Block Styles */
        .code-block-multilang {
            margin: 1.5rem 0;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .code-tabs {
            display: flex;
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
            overflow-x: auto;
        }

        .code-tab {
            padding: 0.875rem 1.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }

        .code-tab:hover {
            background: rgba(37, 99, 235, 0.05);
            color: #2563eb;
        }

        .code-tab.active {
            background: #fff;
            color: #2563eb;
            border-bottom-color: #2563eb;
            font-weight: 600;
        }

        .code-content {
            position: relative;
        }

        .code-content pre {
            margin: 0 !important;
            border-radius: 0 !important;
        }

        .code-content pre code {
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace !important;
            font-size: 0.875rem;
            line-height: 1.7;
        }

        /* Regular code blocks */
        .guide-content pre {
            position: relative;
            margin: 1.5rem 0;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .guide-content pre code {
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace !important;
            font-size: 0.875rem;
        }

        /* Prism.js Line Numbers Styling */
        .line-numbers .line-numbers-rows {
            border-right: 1px solid #4a5568;
            background: #2d3748;
        }

        .line-numbers-rows > span:before {
            color: #718096;
            font-weight: 500;
        }

        /* Prism.js Toolbar Styling */
        div.code-toolbar {
            position: relative;
            margin: 1.5rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        div.code-toolbar > .toolbar {
            opacity: 1;
            right: 0.5rem;
            top: 0.5rem;
        }

        div.code-toolbar > .toolbar > .toolbar-item {
            display: inline-flex;
            align-items: center;
            margin-left: 0.5rem;
        }

        div.code-toolbar > .toolbar > .toolbar-item > button,
        div.code-toolbar > .toolbar > .toolbar-item > span,
        div.code-toolbar > .toolbar > .toolbar-item > a {
            background: rgba(255, 255, 255, 0.95);
            color: #4a5568;
            padding: 0.5rem 0.875rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        div.code-toolbar > .toolbar > .toolbar-item > button:hover,
        div.code-toolbar > .toolbar > .toolbar-item > span:hover,
        div.code-toolbar > .toolbar > .toolbar-item > a:hover {
            background: #fff;
            color: #2563eb;
            border-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37,99,235,0.2);
        }

        div.code-toolbar > .toolbar > .toolbar-item > button:focus,
        div.code-toolbar > .toolbar > .toolbar-item > a:focus {
            outline: none;
        }

        /* Show Language Badge */
        div.code-toolbar > .toolbar .toolbar-item > span.language-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.5rem 0.875rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 0.7rem;
            cursor: default;
            box-shadow: 0 2px 8px rgba(102,126,234,0.3);
        }

        /* Copy Button Success State */
        div.code-toolbar > .toolbar > .toolbar-item > button.copy-to-clipboard-button {
            position: relative;
        }

        div.code-toolbar > .toolbar > .toolbar-item > button.copy-to-clipboard-button[data-copy-state="copy-success"] {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        /* Smooth Scrollbar for Code */
        pre[class*="language-"]::-webkit-scrollbar {
            height: 8px;
        }

        pre[class*="language-"]::-webkit-scrollbar-track {
            background: #2d3748;
        }

        pre[class*="language-"]::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        pre[class*="language-"]::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        /* Enhanced Code Block */
        code[class*="language-"],
        pre[class*="language-"] {
            text-shadow: 0 1px 0 rgba(0, 0, 0, 0.3);
        }

        /* Token Enhancements */
        .token.comment,
        .token.prolog,
        .token.doctype,
        .token.cdata {
            font-style: italic;
        }

        .token.namespace {
            opacity: 0.8;
        }

        .token.important,
        .token.bold {
            font-weight: 700;
        }

        .token.italic {
            font-style: italic;
        }

        .token.entity {
            cursor: help;
        }
    </style>
}

<div class="main-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <h2 class="sidebar-title">@(isEnglish ? "CATEGORIES" : "KATEGORƒ∞LER")</h2>
        <ul class="category-list">
            @foreach (var category in Model.AllCategories)
            {
                var catName = isEnglish && !string.IsNullOrEmpty(category.NameEn) ? category.NameEn : category.NameTr;
                var catSlug = isEnglish && !string.IsNullOrEmpty(category.SlugEn) ? category.SlugEn : category.SlugTr;
                var isActive = category.Id == Model.Category.Id;
                <li class="category-item">
                    <a href="@(isEnglish ? "/en/guides/" : "/rehberler/")@catSlug" class="category-link @(isActive ? "active" : "")">
                        <span class="category-icon">@category.Icon</span>
                        @catName
                    </a>
                </li>
            }
        </ul>
    </aside>

    <!-- Content -->
    <main class="content">
        <nav class="breadcrumb">
            <a href="@(isEnglish ? "/en" : "/")">@(isEnglish ? "Home" : "Ana Sayfa")</a>
            <span class="breadcrumb-sep">‚Ä∫</span>
            <a href="@(isEnglish ? "/en/guides" : "/rehberler")">@(isEnglish ? "Guides" : "Rehberler")</a>
            <span class="breadcrumb-sep">‚Ä∫</span>
            <a href="@(isEnglish ? "/en/guides/" : "/rehberler/")@categorySlug">@categoryName</a>
            <span class="breadcrumb-sep">‚Ä∫</span>
            <span>@Model.Title</span>
        </nav>

        <article class="guide-content">
            <header class="guide-header">
                <div class="guide-tags mb-2">
                    @foreach (var tag in Model.Guide.GuideTags)
                    {
                        var tagName = isEnglish && !string.IsNullOrEmpty(tag.Tag.NameEn) ? tag.Tag.NameEn : tag.Tag.NameTr;
                        <span class="tag" style="@(!string.IsNullOrEmpty(tag.Tag.Color) ? $"background:{tag.Tag.Color};color:#fff;" : "")">
                            @tagName
                        </span>
                    }
                </div>

                <h1>@Model.Title</h1>

                @if (!string.IsNullOrEmpty(Model.Guide.FeaturedImage))
                {
                    var altText = isEnglish && !string.IsNullOrEmpty(Model.Guide.FeaturedImageAltEn) 
                        ? Model.Guide.FeaturedImageAltEn 
                        : Model.Guide.FeaturedImageAltTr;
                    <img src="/appdata/@Model.Guide.FeaturedImage" alt="@altText" style="width: 100%; border-radius: 0.75rem; margin: 1.5rem 0;" />
                }

                @if (!string.IsNullOrEmpty(Model.Summary))
                {
                    <p class="page-description">@Model.Summary</p>
                }

                <div class="guide-header-meta">
                    <span>@Model.Category.Icon @categoryName</span>
                    <span>üìÖ @Model.Guide.CreatedAt.ToString("dd MMMM yyyy")</span>
                    <span>üëÅÔ∏è @Model.Guide.ViewCount.ToString("N0") @(isEnglish ? "views" : "g√∂r√ºnt√ºlenme")</span>
                </div>
            </header>

            <div id="guideContent">
                @Html.Raw(Model.Content)
            </div>

            @* Render Code Blocks from Database *@
            @if (Model.CodeBlocks.Any())
            {
                <input type="hidden" id="codeBlocksData" value='@System.Text.Json.JsonSerializer.Serialize(Model.CodeBlocks)' />
            }

            @if (Model.RelatedGuides.Any())
            {
                <section class="related-section">
                    <h2 class="related-title">@(isEnglish ? "Related Guides" : "ƒ∞lgili Rehberler")</h2>
                    <div class="guide-grid">
                        @foreach (var guide in Model.RelatedGuides)
                        {
                            var relTitle = isEnglish && !string.IsNullOrEmpty(guide.TitleEn) ? guide.TitleEn : guide.TitleTr;
                            var relSummary = isEnglish && !string.IsNullOrEmpty(guide.SummaryEn) ? guide.SummaryEn : guide.SummaryTr;
                            var relCatSlug = isEnglish && !string.IsNullOrEmpty(guide.Category?.SlugEn) ? guide.Category.SlugEn : guide.Category?.SlugTr;
                            var relGuideSlug = isEnglish && !string.IsNullOrEmpty(guide.SlugEn) ? guide.SlugEn : guide.SlugTr;

                            <article class="guide-card">
                                <a href="@(isEnglish ? "/en/guides/" : "/rehberler/")@relCatSlug/@relGuideSlug" class="guide-title">
                                    @relTitle
                                </a>
                                @if (!string.IsNullOrEmpty(relSummary))
                                {
                                    <p class="guide-summary">@relSummary</p>
                                }
                            </article>
                        }
                    </div>
                </section>
            }

            <!-- Back to Category -->
            <div style="margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                <a href="@(isEnglish ? "/en/guides/" : "/rehberler/")@categorySlug" 
                   style="display: inline-block; padding: 0.5rem 1rem; border: 1px solid #e2e8f0; border-radius: 6px; color: #64748b; text-decoration: none; font-size: 0.875rem;">
                    ‚Üê @categoryName
                </a>
            </div>
        </article>
    </main>
</div>

@section Scripts {
    <!-- Prism.js Core with defer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" data-manual defer></script>
    
    <!-- Prism.js Autoloader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js" defer></script>
    
    <!-- Essential Plugins -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/show-language/prism-show-language.min.js" defer></script>

    <script defer>
        // Wait for Prism.js to load and highlight code blocks
        function initializePrism() {
            if (typeof Prism === 'undefined') {
                // Prism not loaded yet, try again
                setTimeout(initializePrism, 50);
                return;
            }
            
            console.log('‚úÖ Prism.js loaded');
            
            // Fix old code blocks without language class
            fixOldCodeBlocks();

            // Render code blocks from DB
            renderCodeBlocksFromDatabase();
            
            // Highlight all code
            Prism.highlightAll();
            console.log('‚úÖ Highlighted', document.querySelectorAll('pre code').length, 'code blocks');
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePrism);
        } else {
            // DOM already loaded
            initializePrism();
        }

        // Fix old code blocks that don't have language-* class
        function fixOldCodeBlocks() {
            document.querySelectorAll('pre code').forEach(function(codeElement) {
                // Check if already has a language class
                const hasLanguageClass = Array.from(codeElement.classList).some(cls => cls.startsWith('language-'));
                
                if (!hasLanguageClass) {
                    // Try to detect language or default to javascript
                    const text = codeElement.textContent;
                    let detectedLang = 'javascript';
                    
                    // Simple language detection
                    if (text.includes('def ') && text.includes(':')) detectedLang = 'python';
                    else if (text.includes('struct ') && text.includes(';')) detectedLang = 'c';
                    else if (text.includes('class ') && text.includes('public ') && text.includes('{')) detectedLang = 'java';
                    else if (text.includes('func ') && text.includes('->')) detectedLang = 'go';
                    else if (text.includes('<?php')) detectedLang = 'php';
                    else if (text.includes('SELECT ') || text.includes('FROM ')) detectedLang = 'sql';
                    
                    codeElement.className = 'language-' + detectedLang;
                    
                    // Add line-numbers to pre
                    if (!codeElement.parentElement.classList.contains('line-numbers')) {
                        codeElement.parentElement.classList.add('line-numbers');
                        codeElement.parentElement.setAttribute('data-start', '1');
                    }
                }
            });
        }

        // Render code blocks from database
        function renderCodeBlocksFromDatabase() {
            const codeBlocksInput = document.getElementById('codeBlocksData');
            if (!codeBlocksInput) return;

            try {
                const codeBlocks = JSON.parse(codeBlocksInput.value);
                if (!codeBlocks || codeBlocks.length === 0) return;

                const content = document.getElementById('guideContent');
                if (!content) return;

                // Find placeholders and replace with actual code blocks
                codeBlocks.forEach(function(block) {
                    const placeholder = content.querySelector('[data-code-id="' + block.BlockId + '"]');
                    if (placeholder) {
                        // Replace placeholder with actual code block from DB
                        const translations = JSON.parse(block.Translations);
                        placeholder.innerHTML = renderCodeBlock(block.BlockId, translations);
                        
                        // Highlight this specific block
                        setTimeout(function() {
                            placeholder.querySelectorAll('code').forEach(function(code) {
                                Prism.highlightElement(code);
                            });
                        }, 50);
                    }
                });
            } catch (e) {
                console.error('Error rendering code blocks:', e);
            }
        }

        // Render a code block with multiple languages
        function renderCodeBlock(blockId, translations) {
            if (!translations || Object.keys(translations).length === 0) {
                return '';
            }

            let html = '<div class="code-tabs">';
            let contentHtml = '';
            let first = true;

            for (const [lang, code] of Object.entries(translations)) {
                const displayName = getLanguageDisplayName(lang);
                
                // Tab button
                html += '<button type="button" class="code-tab' + (first ? ' active' : '') + '" ';
                html += 'data-lang="' + lang + '" ';
                html += 'onclick="switchCodeTab(\'' + blockId + '\', \'' + lang + '\')">';
                html += displayName + '</button>';

                // Code content with Prism.js enhancements
                contentHtml += '<div class="code-content" data-lang="' + lang + '" ';
                contentHtml += 'style="display: ' + (first ? 'block' : 'none') + ';">';
                
                // Pre element with line numbers
                contentHtml += '<pre class="line-numbers" style="margin: 0;" ';
                contentHtml += 'data-start="1">';
                
                // Code element with language class
                contentHtml += '<code class="language-' + lang + '">';
                contentHtml += code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                contentHtml += '</code></pre></div>';

                first = false;
            }

            html += '</div>' + contentHtml;
            return html;
        }

        // Get language display name
        function getLanguageDisplayName(lang) {
            const names = {
                'javascript': 'JavaScript', 'python': 'Python', 'java': 'Java',
                'csharp': 'C#', 'cpp': 'C++', 'c': 'C', 'go': 'Go', 'rust': 'Rust',
                'php': 'PHP', 'ruby': 'Ruby', 'swift': 'Swift', 'kotlin': 'Kotlin',
                'typescript': 'TypeScript', 'dart': 'Dart', 'scala': 'Scala',
                'r': 'R', 'perl': 'Perl', 'lua': 'Lua', 'haskell': 'Haskell',
                'elixir': 'Elixir', 'clojure': 'Clojure', 'fsharp': 'F#',
                'objectivec': 'Objective-C', 'sql': 'SQL', 'html': 'HTML',
                'css': 'CSS', 'bash': 'Bash/Shell', 'powershell': 'PowerShell',
                'json': 'JSON', 'yaml': 'YAML', 'xml': 'XML'
            };
            return names[lang] || lang.toUpperCase();
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Switch Code Tab (for multi-language code blocks)
        function switchCodeTab(codeId, language) {
            const container = document.querySelector('[data-code-id="' + codeId + '"]');
            if (!container) return;

            // Update tabs
            container.querySelectorAll('.code-tab').forEach(tab => {
                const isActive = tab.getAttribute('data-lang') === language;
                tab.classList.toggle('active', isActive);
            });

            // Update content
            let visibleContent = null;
            container.querySelectorAll('.code-content').forEach(content => {
                const isVisible = content.getAttribute('data-lang') === language;
                content.style.display = isVisible ? 'block' : 'none';
                if (isVisible) visibleContent = content;
            });

            // Re-highlight only the visible code for better performance
            if (visibleContent) {
                setTimeout(() => {
                    visibleContent.querySelectorAll('code').forEach(function(code) {
                        Prism.highlightElement(code);
                    });
                }, 50);
            }
        }

    </script>

    <!-- Schema.org structured data for SEO -->
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "Article",
        "headline": "@Model.Title",
        "description": "@Model.MetaDescription",
        "datePublished": "@Model.Guide.CreatedAt.ToString("yyyy-MM-dd")",
        "dateModified": "@(Model.Guide.UpdatedAt?.ToString("yyyy-MM-dd") ?? Model.Guide.CreatedAt.ToString("yyyy-MM-dd"))",
        "author": {
            "@@type": "Organization",
            "name": "@(isEnglish ? "Algorithm Expert" : "Algoritma Uzmanƒ±")"
        },
        "publisher": {
            "@@type": "Organization",
            "name": "@(isEnglish ? "Algorithm Expert" : "Algoritma Uzmanƒ±")"
        },
        "mainEntityOfPage": {
            "@@type": "WebPage",
            "@@id": "@Context.Request.Scheme://@Context.Request.Host@ViewBag.CanonicalUrl"
        }
        @if (ViewBag.SeoTags != null && ((List<string>)ViewBag.SeoTags).Any())
        {
            <text>,
        "keywords": "@string.Join(", ", (List<string>)ViewBag.SeoTags)"</text>
        }
    }
    </script>
}

