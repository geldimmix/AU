@model AlgoritmaUzmani.Models.ViewModels.Admin.GuideViewModel
@{
    ViewData["Title"] = "Yeni Rehber";
    Layout = "_AdminLayout";
}

<form asp-action="CreateGuide" method="post" enctype="multipart/form-data" id="guideForm">
    @Html.AntiForgeryToken()

    <!-- Hidden field for code blocks JSON -->
    <input type="hidden" asp-for="CodeBlocksJson" id="CodeBlocksJson" />

    <div style="display: grid; grid-template-columns: 1fr 350px; gap: 1.5rem;">
        <!-- Main Content -->
        <div>
            <div class="card mb-3">
                <div class="card-header">
                    <h2 class="card-title">ƒ∞√ßerik</h2>
                </div>
                <div class="card-body">
                    <!-- Tabs -->
                    <div class="tabs">
                        <div class="tab active" data-tab="tr">üáπüá∑ T√ºrk√ße</div>
                        <div class="tab" data-tab="en">üá¨üáß ƒ∞ngilizce</div>
                    </div>

                    <!-- Turkish Content -->
                    <div class="tab-content active" id="tab-tr">
                        <div class="form-group">
                            <label asp-for="TitleTr" class="form-label">Ba≈ülƒ±k (TR) *</label>
                            <input asp-for="TitleTr" class="form-control" placeholder="Rehber ba≈ülƒ±ƒüƒ±" />
                            <span asp-validation-for="TitleTr" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="SummaryTr" class="form-label">√ñzet (TR)</label>
                            <textarea asp-for="SummaryTr" class="form-control" rows="2" 
                                      placeholder="Kƒ±sa √∂zet (liste g√∂r√ºn√ºm√ºnde g√∂sterilir)"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ƒ∞√ßerik (TR) *</label>
                            <div class="editor-toolbar">
                                <button type="button" class="editor-btn" onclick="execCmd('bold')" title="Kalƒ±n"><i class="fas fa-bold"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('italic')" title="ƒ∞talik"><i class="fas fa-italic"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('underline')" title="Altƒ± √áizili"><i class="fas fa-underline"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('strikeThrough')" title="√úst√º √áizili"><i class="fas fa-strikethrough"></i></button>
                                <span style="width: 1px; height: 24px; background: var(--border); margin: 0 0.25rem;"></span>
                                <button type="button" class="editor-btn" onclick="execCmd('formatBlock', 'h2')" title="Ba≈ülƒ±k 2">H2</button>
                                <button type="button" class="editor-btn" onclick="execCmd('formatBlock', 'h3')" title="Ba≈ülƒ±k 3">H3</button>
                                <button type="button" class="editor-btn" onclick="execCmd('formatBlock', 'h4')" title="Ba≈ülƒ±k 4">H4</button>
                                <button type="button" class="editor-btn" onclick="execCmd('formatBlock', 'p')" title="Paragraf">P</button>
                                <span style="width: 1px; height: 24px; background: var(--border); margin: 0 0.25rem;"></span>
                                <button type="button" class="editor-btn" onclick="execCmd('insertUnorderedList')" title="Liste"><i class="fas fa-list-ul"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('insertOrderedList')" title="Numaralƒ± Liste"><i class="fas fa-list-ol"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('formatBlock', 'blockquote')" title="Alƒ±ntƒ±"><i class="fas fa-quote-left"></i></button>
                                <button type="button" class="editor-btn" onclick="openCodeEditor()" title="Kod Bloƒüu (Geli≈ümi≈ü)"><i class="fas fa-code"></i></button>
                                <span style="width: 1px; height: 24px; background: var(--border); margin: 0 0.25rem;"></span>
                                <button type="button" class="editor-btn" onclick="insertLink()" title="Link"><i class="fas fa-link"></i></button>
                                <button type="button" class="editor-btn" onclick="insertImage()" title="Resim"><i class="fas fa-image"></i></button>
                                <span style="width: 1px; height: 24px; background: var(--border); margin: 0 0.25rem;"></span>
                                <button type="button" class="editor-btn" onclick="execCmd('justifyLeft')" title="Sola Hizala"><i class="fas fa-align-left"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('justifyCenter')" title="Ortala"><i class="fas fa-align-center"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmd('justifyRight')" title="Saƒüa Hizala"><i class="fas fa-align-right"></i></button>
                            </div>
                            <div class="editor-content" contenteditable="true" id="editorTr" 
                                 style="min-height: 400px;" data-target="ContentTr"></div>
                            <input type="hidden" asp-for="ContentTr" id="ContentTr" />
                            <span asp-validation-for="ContentTr" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- English Content -->
                    <div class="tab-content" id="tab-en">
                        <div class="form-group">
                            <label asp-for="TitleEn" class="form-label">Ba≈ülƒ±k (EN)</label>
                            <input asp-for="TitleEn" class="form-control" placeholder="Guide title" />
                        </div>

                        <div class="form-group">
                            <label asp-for="SummaryEn" class="form-label">√ñzet (EN)</label>
                            <textarea asp-for="SummaryEn" class="form-control" rows="2" 
                                      placeholder="Short summary"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ƒ∞√ßerik (EN)</label>
                            <div class="editor-toolbar">
                                <button type="button" class="editor-btn" onclick="execCmdEn('bold')" title="Bold"><i class="fas fa-bold"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmdEn('italic')" title="Italic"><i class="fas fa-italic"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmdEn('underline')" title="Underline"><i class="fas fa-underline"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmdEn('formatBlock', 'h2')" title="Heading 2">H2</button>
                                <button type="button" class="editor-btn" onclick="execCmdEn('formatBlock', 'h3')" title="Heading 3">H3</button>
                                <button type="button" class="editor-btn" onclick="execCmdEn('formatBlock', 'p')" title="Paragraph">P</button>
                                <button type="button" class="editor-btn" onclick="execCmdEn('insertUnorderedList')" title="List"><i class="fas fa-list-ul"></i></button>
                                <button type="button" class="editor-btn" onclick="execCmdEn('insertOrderedList')" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                                <button type="button" class="editor-btn" onclick="insertLinkEn()" title="Link"><i class="fas fa-link"></i></button>
                                <button type="button" class="editor-btn" onclick="insertImageEn()" title="Image"><i class="fas fa-image"></i></button>
                            </div>
                            <div class="editor-content" contenteditable="true" id="editorEn" 
                                 style="min-height: 400px;" data-target="ContentEn"></div>
                            <input type="hidden" asp-for="ContentEn" id="ContentEn" />
                        </div>

                        <div class="alert alert-success" style="margin-top: 1rem;">
                            <i class="fas fa-info-circle"></i>
                            ƒ∞ngilizce i√ßerik i√ßin kayƒ±t sonrasƒ± "√áevir" butonunu kullanabilirsiniz.
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEO -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 class="card-title">SEO Ayarlarƒ±</h2>
                    <button type="button" class="btn btn-secondary" id="btnSeoSuggestion" onclick="getSeoSuggestions()" style="font-size: 0.85rem; padding: 0.4rem 0.75rem;">
                        <i class="fas fa-magic"></i> AI ile √ñner
                    </button>
                </div>
                <div class="card-body">
                    <div id="seoLoading" style="display: none; text-align: center; padding: 1rem; background: #f1f5f9; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <i class="fas fa-spinner fa-spin"></i> SEO √∂nerileri olu≈üturuluyor...
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label asp-for="MetaDescriptionTr" class="form-label">Meta A√ßƒ±klama (TR)</label>
                            <textarea asp-for="MetaDescriptionTr" class="form-control" rows="2" maxlength="160"
                                      placeholder="Google aramalarƒ±nda g√∂r√ºnecek a√ßƒ±klama (max 160 karakter)"></textarea>
                            <div class="form-hint">Kalan: <span id="metaTrCount">160</span> karakter</div>
                        </div>
                        <div class="form-group">
                            <label asp-for="MetaDescriptionEn" class="form-label">Meta A√ßƒ±klama (EN)</label>
                            <textarea asp-for="MetaDescriptionEn" class="form-control" rows="2" maxlength="160"
                                      placeholder="Description for Google search (max 160 chars)"></textarea>
                            <div class="form-hint">Remaining: <span id="metaEnCount">160</span> characters</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label asp-for="SeoKeywordsTr" class="form-label">SEO Anahtar Kelimeler (TR)</label>
                            <input asp-for="SeoKeywordsTr" class="form-control" 
                                   placeholder="kelime1, kelime2, kelime3" />
                        </div>
                        <div class="form-group">
                            <label asp-for="SeoKeywordsEn" class="form-label">SEO Anahtar Kelimeler (EN)</label>
                            <input asp-for="SeoKeywordsEn" class="form-control" 
                                   placeholder="keyword1, keyword2, keyword3" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div>
            <!-- Publish -->
            <div class="card mb-3">
                <div class="card-header">
                    <h2 class="card-title">Yayƒ±nla</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label asp-for="CategoryId" class="form-label">Kategori *</label>
                        <select asp-for="CategoryId" asp-items="Model.Categories" class="form-control">
                            <option value="">-- Se√ßin --</option>
                        </select>
                        <span asp-validation-for="CategoryId" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <div class="form-check">
                            <input asp-for="IsActive" type="checkbox" />
                            <label asp-for="IsActive">Aktif (Yayƒ±nla)</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-check">
                            <input asp-for="IsFeatured" type="checkbox" />
                            <label asp-for="IsFeatured">√ñne √áƒ±kan</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label asp-for="DisplayOrder" class="form-label">Sƒ±ralama</label>
                        <input asp-for="DisplayOrder" type="number" class="form-control" value="0" />
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-save"></i>
                        Kaydet
                    </button>
                </div>
            </div>

            <!-- Image -->
            <div class="card mb-3">
                <div class="card-header">
                    <h2 class="card-title">√ñne √áƒ±kan G√∂rsel</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <input type="file" name="featuredImage" id="featuredImage" class="form-control" accept="image/*" />
                        <div class="form-hint">Max 10MB (jpg, png, gif, webp)</div>
                    </div>
                    <div id="imagePreview" style="margin-top: 0.5rem;"></div>

                    <div class="form-group mt-2">
                        <label asp-for="FeaturedImageAltTr" class="form-label">Alt Yazƒ± (TR)</label>
                        <input asp-for="FeaturedImageAltTr" class="form-control" placeholder="G√∂rsel a√ßƒ±klamasƒ±" />
                    </div>

                    <div class="form-group">
                        <label asp-for="FeaturedImageAltEn" class="form-label">Alt Yazƒ± (EN)</label>
                        <input asp-for="FeaturedImageAltEn" class="form-control" placeholder="Image description" />
                    </div>
                </div>
            </div>

            <!-- Tags -->
            <div class="card mb-3">
                <div class="card-header">
                    <h2 class="card-title">Etiketler</h2>
                </div>
                <div class="card-body">
                    <div class="form-group mb-0">
                        <label class="form-label">Ana Etiketler</label>
                        <select asp-for="SelectedTagIds" asp-items="Model.Tags" class="form-control" multiple>
                        </select>
                        <div class="form-hint">Ctrl+Click ile √ßoklu se√ßim</div>
                    </div>
                </div>
            </div>

            <!-- SEO Tags -->
            <div class="card mb-3">
                <div class="card-header">
                    <h2 class="card-title">SEO Etiketleri</h2>
                </div>
                <div class="card-body">
                    <div class="form-group mb-0">
                        <select asp-for="SelectedSeoTagIds" asp-items="Model.SeoTags" class="form-control" multiple>
                        </select>
                        <div class="form-hint">Google botlarƒ± i√ßin gizli etiketler</div>
                    </div>
                </div>
            </div>

            <!-- Related Guides -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">ƒ∞lgili Rehberler</h2>
                </div>
                <div class="card-body">
                    <div class="form-group mb-0">
                        <select asp-for="RelatedGuideIds" asp-items="Model.AllGuides" class="form-control" multiple>
                        </select>
                        <div class="form-hint">Sayfada g√∂sterilecek ilgili rehberler</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Image Upload Modal -->
<div class="modal-overlay" id="imageModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Resim Ekle</h3>
            <button type="button" class="modal-close" onclick="closeImageModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="tabs" style="margin-bottom: 1rem;">
                <div class="tab active" data-modal-tab="upload">Y√ºkle</div>
                <div class="tab" data-modal-tab="url">URL</div>
            </div>
            
            <div id="modal-upload" class="tab-content active">
                <div class="form-group">
                    <label class="form-label">Resim Se√ß</label>
                    <input type="file" id="modalImageFile" class="form-control" accept="image/*" />
                </div>
            </div>
            
            <div id="modal-url" class="tab-content">
                <div class="form-group">
                    <label class="form-label">Resim URL</label>
                    <input type="text" id="modalImageUrl" class="form-control" placeholder="https://..." />
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Hizalama</label>
                <select id="imageAlign" class="form-control">
                    <option value="">Varsayƒ±lan</option>
                    <option value="left">Sol</option>
                    <option value="center">Orta</option>
                    <option value="right">Saƒü</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Geni≈ülik (px veya %)</label>
                <input type="text" id="imageWidth" class="form-control" placeholder="√ñrn: 500 veya 100%" />
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeImageModal()">ƒ∞ptal</button>
            <button type="button" class="btn btn-primary" onclick="confirmInsertImage()">Ekle</button>
        </div>
    </div>
</div>

<!-- Code Editor Modal -->
<div class="modal-overlay" id="codeModal">
    <div class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h3 class="modal-title">Kod Bloƒüu Ekle</h3>
            <button type="button" class="modal-close" onclick="closeCodeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Programlama Dili</label>
                <select id="codeLanguage" class="form-control">
                    <option value="javascript">JavaScript</option>
                    <option value="python">Python</option>
                    <option value="java">Java</option>
                    <option value="csharp">C#</option>
                    <option value="cpp">C++</option>
                    <option value="c">C</option>
                    <option value="go">Go</option>
                    <option value="rust">Rust</option>
                    <option value="php">PHP</option>
                    <option value="ruby">Ruby</option>
                    <option value="swift">Swift</option>
                    <option value="kotlin">Kotlin</option>
                    <option value="typescript">TypeScript</option>
                    <option value="dart">Dart</option>
                    <option value="scala">Scala</option>
                    <option value="r">R</option>
                    <option value="perl">Perl</option>
                    <option value="lua">Lua</option>
                    <option value="haskell">Haskell</option>
                    <option value="elixir">Elixir</option>
                    <option value="clojure">Clojure</option>
                    <option value="fsharp">F#</option>
                    <option value="objectivec">Objective-C</option>
                    <option value="sql">SQL</option>
                    <option value="html">HTML</option>
                    <option value="css">CSS</option>
                    <option value="bash">Bash/Shell</option>
                    <option value="powershell">PowerShell</option>
                    <option value="json">JSON</option>
                    <option value="yaml">YAML</option>
                    <option value="xml">XML</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Kodunuz</label>
                <textarea id="codeInput" class="form-control" rows="15" 
                    placeholder="// Kodunuzu buraya yazƒ±n..." 
                    style="font-family: 'Consolas', 'Monaco', monospace; font-size: 14px;"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="enableMultiLang" style="margin-right: 0.5rem;">
                    √áoklu Dil Desteƒüi (Deep Infra ile √ßeviri)
                </label>
            </div>

            <div id="multiLangOptions" style="display: none;">
                <div class="form-group">
                    <label class="form-label">
                        √áevrilecek Diller 
                        <small class="text-muted">(Ctrl+Click ile se√ßimi deƒüi≈ütir, varsayƒ±lan hepsi se√ßili)</small>
                    </label>
                    <select id="targetLanguages" class="form-control" multiple style="min-height: 200px;">
                        <option value="javascript" selected>JavaScript</option>
                        <option value="python" selected>Python</option>
                        <option value="java" selected>Java</option>
                        <option value="csharp" selected>C#</option>
                        <option value="cpp" selected>C++</option>
                        <option value="c" selected>C</option>
                        <option value="go" selected>Go</option>
                        <option value="rust" selected>Rust</option>
                        <option value="php" selected>PHP</option>
                        <option value="ruby" selected>Ruby</option>
                        <option value="swift" selected>Swift</option>
                        <option value="kotlin" selected>Kotlin</option>
                        <option value="typescript" selected>TypeScript</option>
                        <option value="dart" selected>Dart</option>
                        <option value="scala" selected>Scala</option>
                        <option value="r" selected>R</option>
                        <option value="perl" selected>Perl</option>
                        <option value="lua" selected>Lua</option>
                        <option value="haskell" selected>Haskell</option>
                        <option value="elixir" selected>Elixir</option>
                    </select>
                    <div class="form-hint" style="margin-top: 0.5rem;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="selectAllLanguages()">
                            <i class="fas fa-check-double"></i> T√ºm√ºn√º Se√ß
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="deselectAllLanguages()">
                            <i class="fas fa-times"></i> T√ºm√ºn√º Kaldƒ±r
                        </button>
                    </div>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="translateCode()" id="btnTranslateCode">
                    <i class="fas fa-language"></i> T√ºm Dillere √áevir
                </button>
                
                <div id="translationProgress" style="display: none; margin-top: 1rem;">
                    <div style="padding: 1rem; background: #f1f5f9; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-spinner fa-spin" style="color: #2563eb;"></i>
                            <span id="progressText" style="font-weight: 600; color: #1e293b;">
                                √áeviriler hazƒ±rlanƒ±yor...
                            </span>
                        </div>
                        <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.75rem;" id="progressDetail">
                            Deep Infra API ile √ßeviriler yapƒ±lƒ±yor. Bu i≈ülem 30-60 saniye s√ºrebilir.
                        </div>
                        <!-- Progress Bar -->
                        <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                            <div id="progressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #2563eb 0%, #7c3aed 100%); transition: width 0.3s ease;"></div>
                        </div>
                        <div style="text-align: center; margin-top: 0.5rem; font-size: 0.875rem; color: #64748b;" id="progressPercent">
                            0%
                        </div>
                    </div>
                    <div style="padding: 0.75rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 0.5rem; font-size: 0.875rem; color: #92400e;">
                        <i class="fas fa-info-circle"></i> 
                        <strong>√ñnemli:</strong> L√ºtfen sayfayƒ± kapatmayƒ±n veya yenilemeyin. √áeviri i≈ülemi devam ediyor.
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCodeModal()">ƒ∞ptal</button>
            <button type="button" class="btn btn-primary" onclick="insertCodeBlock()">
                <i class="fas fa-plus"></i> Ekle
            </button>
        </div>
    </div>
</div>

@section Scripts {
<!-- Prism.js for Code Highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css" rel="stylesheet" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-ruby.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-swift.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-kotlin.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-dart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-scala.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-r.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-perl.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-haskell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-elixir.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clojure.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-fsharp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-objectivec.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-powershell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

<!-- Prism.js Plugins for Admin Preview -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>

<script>
    // Tabs
    document.querySelectorAll('.tab[data-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            document.querySelectorAll('.tab[data-tab]').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        });
    });

    // Modal Tabs
    document.querySelectorAll('.tab[data-modal-tab]').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-modal-tab');
            document.querySelectorAll('.tab[data-modal-tab]').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#imageModal .tab-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('modal-' + tabId).classList.add('active');
        });
    });

    // Editor Commands
    function execCmd(command, value = null) {
        document.getElementById('editorTr').focus();
        document.execCommand(command, false, value);
    }

    function execCmdEn(command, value = null) {
        document.getElementById('editorEn').focus();
        document.execCommand(command, false, value);
    }

    // Code Editor Variables
    let currentCodeTranslations = {};
    let currentCodeLanguage = 'javascript';
    let codeBlocksData = []; // Stores all code blocks with translations

    // Open Code Editor Modal
    function openCodeEditor() {
        currentEditor = 'tr';
        currentCodeTranslations = {};
        document.getElementById('codeInput').value = '';
        document.getElementById('codeLanguage').value = 'javascript';
        document.getElementById('enableMultiLang').checked = false;
        document.getElementById('multiLangOptions').style.display = 'none';
        document.getElementById('codeModal').classList.add('active');
    }

    // Close Code Editor Modal
    function closeCodeModal() {
        document.getElementById('codeModal').classList.remove('active');
    }

    // Toggle Multi-Language Options
    document.addEventListener('DOMContentLoaded', function() {
        const enableMultiLang = document.getElementById('enableMultiLang');
        if (enableMultiLang) {
            enableMultiLang.addEventListener('change', function() {
                document.getElementById('multiLangOptions').style.display = 
                    this.checked ? 'block' : 'none';
            });
        }
    });

    // Translate Code using Deep Infra
    async function translateCode() {
        const sourceCode = document.getElementById('codeInput').value;
        const sourceLang = document.getElementById('codeLanguage').value;
        const targetLangs = Array.from(document.getElementById('targetLanguages').selectedOptions)
            .map(opt => opt.value);

        if (!sourceCode.trim()) {
            alert('L√ºtfen √∂nce bir kod yazƒ±n');
            return;
        }

        if (targetLangs.length === 0) {
            alert('L√ºtfen en az bir hedef dil se√ßin');
            return;
        }

        const btn = document.getElementById('btnTranslateCode');
        const progress = document.getElementById('translationProgress');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressText = document.getElementById('progressText');
        const progressDetail = document.getElementById('progressDetail');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> √áevriliyor...';
        progress.style.display = 'block';

        // Simulate progress (since backend does all translations at once)
        let currentProgress = 0;
        const totalLanguages = targetLangs.length;
        const estimatedTime = totalLanguages * 2; // 2 seconds per language estimate
        
        progressText.textContent = `${totalLanguages} dile √ßeviri yapƒ±lƒ±yor...`;
        progressDetail.textContent = `Tahmini s√ºre: ${estimatedTime} saniye. L√ºtfen bekleyin ve sayfayƒ± yenilemeyin.`;

        // Progress animation
        const progressInterval = setInterval(() => {
            if (currentProgress < 90) {
                currentProgress += Math.random() * 3;
                if (currentProgress > 90) currentProgress = 90;
                progressBar.style.width = currentProgress + '%';
                progressPercent.textContent = Math.floor(currentProgress) + '%';
            }
        }, 500);

        try {
            const startTime = Date.now();
            
            const response = await fetch('/admin/translate-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify({
                    sourceCode: sourceCode,
                    sourceLanguage: sourceLang,
                    targetLanguages: targetLangs
                })
            });

            clearInterval(progressInterval);
            const elapsedTime = Math.floor((Date.now() - startTime) / 1000);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();

            if (result.success) {
                currentCodeTranslations = result.translations;
                currentCodeLanguage = sourceLang;
                
                // Complete progress
                progressBar.style.width = '100%';
                progressPercent.textContent = '100%';
                progressText.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> √áeviriler tamamlandƒ±!';
                progressDetail.textContent = `${Object.keys(result.translations).length} dil ba≈üarƒ±yla √ßevrildi (${elapsedTime} saniye).`;
                
                setTimeout(() => {
                    progress.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressPercent.textContent = '0%';
                    alert(`‚úÖ Ba≈üarƒ±lƒ±!\n\n${Object.keys(result.translations).length} dile √ßeviri tamamlandƒ±.\n≈ûimdi "Ekle" butonuna tƒ±klayarak kodu i√ßeriƒüe ekleyebilirsiniz.`);
                }, 2000);
            } else {
                throw new Error(result.error || 'Bilinmeyen hata');
            }
        } catch (e) {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            progressBar.style.background = '#ef4444';
            progressText.innerHTML = '<i class="fas fa-times-circle" style="color: #ef4444;"></i> Hata olu≈ütu!';
            progressDetail.textContent = e.message;
            
            setTimeout(() => {
                progress.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.style.background = 'linear-gradient(90deg, #2563eb 0%, #7c3aed 100%)';
                alert('‚ùå Hata: ' + e.message + '\n\nL√ºtfen tekrar deneyin veya daha az dil se√ßin.');
            }, 3000);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-language"></i> T√ºm Dillere √áevir';
        }
    }

    // Insert Code Block into Editor
    function insertCodeBlock() {
        const code = document.getElementById('codeInput').value;
        const lang = document.getElementById('codeLanguage').value;
        const enableMulti = document.getElementById('enableMultiLang').checked;

        if (!code.trim()) {
            alert('L√ºtfen kod yazƒ±n');
            return;
        }

        const codeId = 'code-' + Date.now();
        let html = '';

        // Save to codeBlocksData array for backend
        const codeBlockData = {
            blockId: codeId,
            sourceLanguage: lang,
            sourceCode: code,
            translations: enableMulti && Object.keys(currentCodeTranslations).length > 0 
                ? currentCodeTranslations 
                : { [lang]: code },
            displayOrder: codeBlocksData.length
        };
        codeBlocksData.push(codeBlockData);

        if (enableMulti && Object.keys(currentCodeTranslations).length > 0) {
            // Multi-language code block with tabs
            html = '<div class="code-block-multilang" data-code-id="' + codeId + '" data-block-idx="' + (codeBlocksData.length - 1) + '" style="margin: 1.5rem 0; border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden;">';
            
            // Language tabs
            html += '<div class="code-tabs" style="display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">';
            let first = true;
            for (const [language, translation] of Object.entries(currentCodeTranslations)) {
                const displayName = getLanguageDisplayName(language);
                html += '<button type="button" class="code-tab ' + (first ? 'active' : '') + '" ';
                html += 'data-lang="' + language + '" ';
                html += 'onclick="switchCodeTab(\'' + codeId + '\', \'' + language + '\')" ';
                html += 'style="padding: 0.75rem 1.25rem; border: none; background: ' + (first ? '#fff' : 'transparent') + '; ';
                html += 'cursor: pointer; font-weight: 500; color: ' + (first ? '#2563eb' : '#64748b') + ';">';
                html += displayName + '</button>';
                first = false;
            }
            html += '</div>';

            // Code contents with Prism.js enhancements
            first = true;
            for (const [language, translation] of Object.entries(currentCodeTranslations)) {
                html += '<div class="code-content" data-lang="' + language + '" ';
                html += 'style="display: ' + (first ? 'block' : 'none') + ';">';
                html += '<pre class="line-numbers" style="margin: 0;" data-start="1">';
                html += '<code class="language-' + language + '">';
                html += escapeHtml(translation);
                html += '</code></pre></div>';
                first = false;
            }

            html += '</div><p></p>';
        } else {
            // Single language code block with Prism.js enhancements
            html = '<div class="code-block-single" data-code-id="' + codeId + '" data-block-idx="' + (codeBlocksData.length - 1) + '">';
            html += '<pre class="line-numbers" data-start="1">';
            html += '<code class="language-' + lang + '">';
            html += escapeHtml(code);
            html += '</code></pre></div><p></p>';
        }

        const editor = currentEditor === 'tr' ? 
            document.getElementById('editorTr') : 
            document.getElementById('editorEn');
        
        editor.focus();
        document.execCommand('insertHTML', false, html);

        // Highlight the code
        setTimeout(() => {
            Prism.highlightAll();
        }, 100);

        closeCodeModal();
    }

    // Switch Code Tab
    function switchCodeTab(codeId, language) {
        const container = document.querySelector('[data-code-id="' + codeId + '"]');
        if (!container) return;

        // Update tabs
        container.querySelectorAll('.code-tab').forEach(tab => {
            const isActive = tab.getAttribute('data-lang') === language;
            tab.classList.toggle('active', isActive);
            tab.style.background = isActive ? '#fff' : 'transparent';
            tab.style.color = isActive ? '#2563eb' : '#64748b';
        });

        // Update content
        container.querySelectorAll('.code-content').forEach(content => {
            content.style.display = 
                content.getAttribute('data-lang') === language ? 'block' : 'none';
        });
    }

    // Select/Deselect All Languages
    function selectAllLanguages() {
        const select = document.getElementById('targetLanguages');
        Array.from(select.options).forEach(opt => opt.selected = true);
    }

    function deselectAllLanguages() {
        const select = document.getElementById('targetLanguages');
        Array.from(select.options).forEach(opt => opt.selected = false);
    }

    // Get Language Display Name
    function getLanguageDisplayName(lang) {
        const names = {
            'javascript': 'JavaScript',
            'python': 'Python',
            'java': 'Java',
            'csharp': 'C#',
            'cpp': 'C++',
            'c': 'C',
            'go': 'Go',
            'rust': 'Rust',
            'php': 'PHP',
            'ruby': 'Ruby',
            'swift': 'Swift',
            'kotlin': 'Kotlin',
            'typescript': 'TypeScript',
            'dart': 'Dart',
            'scala': 'Scala',
            'r': 'R',
            'perl': 'Perl',
            'lua': 'Lua',
            'haskell': 'Haskell',
            'elixir': 'Elixir',
            'clojure': 'Clojure',
            'fsharp': 'F#',
            'objectivec': 'Objective-C',
            'sql': 'SQL',
            'html': 'HTML',
            'css': 'CSS',
            'bash': 'Bash/Shell',
            'powershell': 'PowerShell',
            'json': 'JSON',
            'yaml': 'YAML',
            'xml': 'XML'
        };
        return names[lang] || lang.toUpperCase();
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function insertLink() {
        const url = prompt('Link URL:', 'https://');
        if (url) {
            execCmd('createLink', url);
        }
    }

    function insertLinkEn() {
        const url = prompt('Link URL:', 'https://');
        if (url) {
            document.getElementById('editorEn').focus();
            document.execCommand('createLink', false, url);
        }
    }

    let currentEditor = 'tr';
    
    function insertImage() {
        currentEditor = 'tr';
        document.getElementById('imageModal').classList.add('active');
    }

    function insertImageEn() {
        currentEditor = 'en';
        document.getElementById('imageModal').classList.add('active');
    }

    function closeImageModal() {
        document.getElementById('imageModal').classList.remove('active');
        document.getElementById('modalImageFile').value = '';
        document.getElementById('modalImageUrl').value = '';
        document.getElementById('imageWidth').value = '';
        document.getElementById('imageAlign').value = '';
    }

    async function confirmInsertImage() {
        const file = document.getElementById('modalImageFile').files[0];
        const url = document.getElementById('modalImageUrl').value;
        const width = document.getElementById('imageWidth').value;
        const align = document.getElementById('imageAlign').value;
        
        let imgUrl = url;
        
        if (file) {
            // Upload file
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/admin/upload-image', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    imgUrl = result.url;
                } else {
                    alert('Y√ºkleme hatasƒ±: ' + result.error);
                    return;
                }
            } catch (e) {
                alert('Y√ºkleme hatasƒ±: ' + e.message);
                return;
            }
        }
        
        if (!imgUrl) {
            alert('L√ºtfen bir resim se√ßin veya URL girin');
            return;
        }
        
        let style = '';
        if (width) style += 'width:' + width + ';';
        if (align === 'center') style += 'display:block;margin:0 auto;';
        else if (align === 'left') style += 'float:left;margin-right:1rem;';
        else if (align === 'right') style += 'float:right;margin-left:1rem;';
        
        const img = '<img src="' + imgUrl + '"' + (style ? ' style="' + style + '"' : '') + ' />';
        
        const editor = currentEditor === 'tr' ? document.getElementById('editorTr') : document.getElementById('editorEn');
        editor.focus();
        document.execCommand('insertHTML', false, img);
        
        closeImageModal();
    }

    // Featured Image Preview
    document.getElementById('featuredImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').innerHTML = 
                    '<img src="' + e.target.result + '" style="max-width:100%;border-radius:0.5rem;" />';
            };
            reader.readAsDataURL(file);
        }
    });

    // Meta description counter
    document.getElementById('MetaDescriptionTr').addEventListener('input', function() {
        document.getElementById('metaTrCount').textContent = 160 - this.value.length;
    });
    document.getElementById('MetaDescriptionEn').addEventListener('input', function() {
        document.getElementById('metaEnCount').textContent = 160 - this.value.length;
    });

    // Handle paste events to prevent HTML escape issues
    document.getElementById('editorTr').addEventListener('paste', function(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text/html') || 
                     (e.clipboardData || window.clipboardData).getData('text');
        
        // Use execCommand to maintain editor state
        document.execCommand('insertHTML', false, text);
    });

    document.getElementById('editorEn').addEventListener('paste', function(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text/html') || 
                     (e.clipboardData || window.clipboardData).getData('text');
        
        document.execCommand('insertHTML', false, text);
    });

    // Form submit - copy editor content and code blocks
    document.getElementById('guideForm').addEventListener('submit', function(e) {
        document.getElementById('ContentTr').value = document.getElementById('editorTr').innerHTML;
        document.getElementById('ContentEn').value = document.getElementById('editorEn').innerHTML;
        
        // Save code blocks as JSON
        if (codeBlocksData.length > 0) {
            document.getElementById('CodeBlocksJson').value = JSON.stringify(codeBlocksData);
        }

        // Show loading overlay
        showSaveProgress();
    });

    // Show save progress overlay
    function showSaveProgress() {
        const overlay = document.createElement('div');
        overlay.id = 'saveOverlay';
        overlay.style.cssText = `
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        `;
        
        overlay.innerHTML = `
            <div style="background: white; padding: 2rem 3rem; border-radius: 1rem; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; border: 4px solid #e2e8f0; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <h3 style="margin: 0 0 0.5rem; color: #1e293b; font-size: 1.25rem;">Rehber Kaydediliyor</h3>
                <p style="margin: 0; color: #64748b; font-size: 0.875rem;">L√ºtfen bekleyin, i≈ülem tamamlanƒ±yor...</p>
                <p style="margin: 1rem 0 0; color: #f59e0b; font-size: 0.75rem; font-weight: 600;">
                    <i class="fas fa-info-circle"></i> Sayfayƒ± kapatmayƒ±n
                </p>
            </div>
            <style>
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            </style>
        `;
        
        document.body.appendChild(overlay);
    }

    // Load existing content
    window.addEventListener('load', function() {
        const contentTr = document.getElementById('ContentTr').value;
        const contentEn = document.getElementById('ContentEn').value;
        if (contentTr) document.getElementById('editorTr').innerHTML = contentTr;
        if (contentEn) document.getElementById('editorEn').innerHTML = contentEn;
    });

    // SEO Suggestions
    async function getSeoSuggestions() {
        const title = document.getElementById('TitleTr').value;
        const content = document.getElementById('editorTr').innerHTML;
        
        if (!title && !content) {
            alert('L√ºtfen √∂nce ba≈ülƒ±k veya i√ßerik girin');
            return;
        }
        
        const btn = document.getElementById('btnSeoSuggestion');
        const loading = document.getElementById('seoLoading');
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Bekleniyor...';
        loading.style.display = 'block';
        
        try {
            const response = await fetch('/admin/guides/seo-suggestions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title, content })
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (result.metaDescription) {
                    document.getElementById('MetaDescriptionTr').value = result.metaDescription;
                    document.getElementById('metaTrCount').textContent = 160 - result.metaDescription.length;
                }
                if (result.keywords) {
                    document.getElementById('SeoKeywordsTr').value = result.keywords;
                }
                alert('SEO √∂nerileri ba≈üarƒ±yla eklendi! ƒ∞sterseniz d√ºzenleyebilirsiniz.');
            } else {
                alert('Hata: ' + result.error);
            }
        } catch (e) {
            alert('Bir hata olu≈ütu: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> AI ile √ñner';
            loading.style.display = 'none';
        }
    }
</script>
}

