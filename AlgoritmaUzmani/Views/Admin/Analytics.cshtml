@model List<AlgoritmaUzmani.Models.Entities.VisitorLog>
@{
    ViewData["Title"] = "Ziyaretçi Analizi";
    Layout = "_AdminLayout";
    
    var totalVisits = (int)ViewBag.TotalVisits;
    var uniqueVisitors = (int)ViewBag.UniqueVisitors;
    var todayVisits = (int)ViewBag.TodayVisits;
    var browserStats = (Dictionary<string, int>)ViewBag.BrowserStats;
    var deviceStats = (Dictionary<string, int>)ViewBag.DeviceStats;
    var osStats = (Dictionary<string, int>)ViewBag.OsStats;
    var topPages = (Dictionary<string, int>)ViewBag.TopPages;
    var dailyVisits = (Dictionary<DateTime, int>)ViewBag.DailyVisits;
}

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon blue">
            <i class="fas fa-eye"></i>
        </div>
        <div class="stat-label">Son 30 Gün Ziyaret</div>
        <div class="stat-value">@totalVisits.ToString("N0")</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-label">Tekil Ziyaretçi</div>
        <div class="stat-value">@uniqueVisitors.ToString("N0")</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon purple">
            <i class="fas fa-calendar-day"></i>
        </div>
        <div class="stat-label">Bugün</div>
        <div class="stat-value">@todayVisits.ToString("N0")</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon orange">
            <i class="fas fa-chart-bar"></i>
        </div>
        <div class="stat-label">Günlük Ortalama</div>
        <div class="stat-value">@((totalVisits / 30.0).ToString("N0"))</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
    <!-- Daily Visits Chart -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Son 30 Gün Ziyaretleri</h2>
        </div>
        <div class="card-body">
            <div style="display: flex; align-items: flex-end; gap: 4px; height: 200px;">
                @{
                    var maxVisit = dailyVisits.Values.Any() ? dailyVisits.Values.Max() : 1;
                }
                @foreach (var day in dailyVisits)
                {
                    var height = maxVisit > 0 ? (day.Value / (double)maxVisit * 180) : 0;
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;" title="@day.Key.ToString("dd MMM"): @day.Value ziyaret">
                        <div style="width: 100%; background: #3b82f6; border-radius: 2px 2px 0 0; min-height: 2px; height: @(height)px;"></div>
                    </div>
                }
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-secondary);">
                <span>@dailyVisits.Keys.First().ToString("dd MMM")</span>
                <span>@dailyVisits.Keys.Last().ToString("dd MMM")</span>
            </div>
        </div>
    </div>

    <!-- Device Stats -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Cihaz Dağılımı</h2>
        </div>
        <div class="card-body">
            @if (deviceStats.Any())
            {
                var totalDevices = deviceStats.Values.Sum();
                foreach (var device in deviceStats.OrderByDescending(x => x.Value))
                {
                    var percent = totalDevices > 0 ? (device.Value / (double)totalDevices * 100) : 0;
                    var icon = device.Key switch {
                        "Desktop" => "fa-desktop",
                        "Mobile" => "fa-mobile-alt",
                        "Tablet" => "fa-tablet-alt",
                        _ => "fa-question"
                    };
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span><i class="fas @icon" style="margin-right: 0.5rem;"></i>@device.Key</span>
                            <span>@percent.ToString("N1")%</span>
                        </div>
                        <div style="height: 6px; background: #e2e8f0; border-radius: 3px;">
                            <div style="height: 100%; width: @(percent)%; background: #3b82f6; border-radius: 3px;"></div>
                        </div>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">Henüz veri yok</p>
            }
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
    <!-- Browser Stats -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Tarayıcılar</h2>
        </div>
        <div class="card-body">
            @if (browserStats.Any())
            {
                foreach (var browser in browserStats.OrderByDescending(x => x.Value).Take(5))
                {
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f1f5f9;">
                        <span>@browser.Key</span>
                        <span class="badge badge-info">@browser.Value</span>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">Henüz veri yok</p>
            }
        </div>
    </div>

    <!-- OS Stats -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">İşletim Sistemleri</h2>
        </div>
        <div class="card-body">
            @if (osStats.Any())
            {
                foreach (var os in osStats.OrderByDescending(x => x.Value).Take(5))
                {
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f1f5f9;">
                        <span>@os.Key</span>
                        <span class="badge badge-info">@os.Value</span>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">Henüz veri yok</p>
            }
        </div>
    </div>

    <!-- Top Pages -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Popüler Sayfalar</h2>
        </div>
        <div class="card-body">
            @if (topPages.Any())
            {
                foreach (var topPage in topPages.Take(5))
                {
                    var displayUrl = topPage.Key.Length > 30 ? topPage.Key.Substring(0, 27) + "..." : topPage.Key;
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f1f5f9;" title="@topPage.Key">
                        <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 150px;">@displayUrl</span>
                        <span class="badge badge-success">@topPage.Value</span>
                    </div>
                }
            }
            else
            {
                <p class="text-muted">Henüz veri yok</p>
            }
        </div>
    </div>
</div>

<!-- Recent Visitors -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Son Ziyaretçiler</h2>
        <a href="/admin/analytics/visitors" class="btn btn-secondary btn-sm">
            <i class="fas fa-list"></i> Tümünü Gör
        </a>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>IP Adresi</th>
                        <th>Tarayıcı</th>
                        <th>Cihaz</th>
                        <th>İşletim Sistemi</th>
                        <th>Sayfa</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var visitor in Model.Take(20))
                    {
                        <tr>
                            <td>
                                <span style="font-size: 0.8rem;">@visitor.VisitedAt.ToString("dd.MM.yyyy HH:mm")</span>
                            </td>
                            <td>
                                <code style="background: #f1f5f9; padding: 0.125rem 0.375rem; border-radius: 4px; font-size: 0.8rem;">@visitor.IpAddress</code>
                            </td>
                            <td>
                                @visitor.Browser
                                @if (!string.IsNullOrEmpty(visitor.BrowserVersion))
                                {
                                    <span class="text-muted" style="font-size: 0.75rem;">@visitor.BrowserVersion</span>
                                }
                            </td>
                            <td>
                                @{
                                    var deviceIcon = visitor.DeviceType switch {
                                        "Desktop" => "fa-desktop",
                                        "Mobile" => "fa-mobile-alt",
                                        "Tablet" => "fa-tablet-alt",
                                        _ => "fa-question"
                                    };
                                }
                                <i class="fas @deviceIcon text-muted"></i>
                                @visitor.DeviceType
                            </td>
                            <td>@visitor.OperatingSystem</td>
                            <td>
                                @{
                                    var pageUrl = visitor.PageUrl ?? "/";
                                    var shortUrl = pageUrl.Length > 40 ? pageUrl.Substring(0, 37) + "..." : pageUrl;
                                }
                                <a href="@pageUrl" target="_blank" title="@pageUrl" style="color: var(--primary);">@shortUrl</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

